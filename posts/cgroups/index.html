<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <meta name="google-site-verification" content="BgUHgNcBMb7gYvy2sM6W6KrWgBuDk4YU9eooUbig5oM" />
    <title>Using Cgroups v2 to limit system I/O resources - Coding Panda&#39;s Blog</title><meta name="author" content="Zhiwei Zhang">
<meta name="author-link" content="https://github.com/zhiwayzhang">
<meta name="description" content="Introduction to Cgroups Cgroups, which called control group in Linux to limit system resources for specify process group, is comonly used in many container tech, such as Docker, Kubernetes, iSulad etc.
The cgroup architecture is comprised of two main components:
the cgroup core: which contains a pseudo-filesystem cgroupfs, the subsystem controllers: thresholds for system resources, such as memory, CPU, I/O, PIDS, RDMA, etc. The hierarchy of Cgroups In Cgroups v1, per-resource (memory, cpu, blkio) have it&rsquo;s own hierarchy, where each resource hierarchy contains cgroups for that resource." /><meta name="keywords" content='I/O, Linux, Cgroups' /><meta itemprop="name" content="Using Cgroups v2 to limit system I/O resources">
<meta itemprop="description" content="Introduction to Cgroups Cgroups, which called control group in Linux to limit system resources for specify process group, is comonly used in many container tech, such as Docker, Kubernetes, iSulad etc.
The cgroup architecture is comprised of two main components:
the cgroup core: which contains a pseudo-filesystem cgroupfs, the subsystem controllers: thresholds for system resources, such as memory, CPU, I/O, PIDS, RDMA, etc. The hierarchy of Cgroups In Cgroups v1, per-resource (memory, cpu, blkio) have it&rsquo;s own hierarchy, where each resource hierarchy contains cgroups for that resource."><meta itemprop="datePublished" content="2023-04-07T19:51:41+08:00" />
<meta itemprop="dateModified" content="2023-04-07T19:51:41+08:00" />
<meta itemprop="wordCount" content="1188">
<meta itemprop="keywords" content="I/O,Linux,Cgroups," /><meta property="og:title" content="Using Cgroups v2 to limit system I/O resources" />
<meta property="og:description" content="Introduction to Cgroups Cgroups, which called control group in Linux to limit system resources for specify process group, is comonly used in many container tech, such as Docker, Kubernetes, iSulad etc.
The cgroup architecture is comprised of two main components:
the cgroup core: which contains a pseudo-filesystem cgroupfs, the subsystem controllers: thresholds for system resources, such as memory, CPU, I/O, PIDS, RDMA, etc. The hierarchy of Cgroups In Cgroups v1, per-resource (memory, cpu, blkio) have it&rsquo;s own hierarchy, where each resource hierarchy contains cgroups for that resource." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhiwayzhang.github.io/posts/cgroups/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-07T19:51:41+08:00" />
<meta property="article:modified_time" content="2023-04-07T19:51:41+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Using Cgroups v2 to limit system I/O resources"/>
<meta name="twitter:description" content="Introduction to Cgroups Cgroups, which called control group in Linux to limit system resources for specify process group, is comonly used in many container tech, such as Docker, Kubernetes, iSulad etc.
The cgroup architecture is comprised of two main components:
the cgroup core: which contains a pseudo-filesystem cgroupfs, the subsystem controllers: thresholds for system resources, such as memory, CPU, I/O, PIDS, RDMA, etc. The hierarchy of Cgroups In Cgroups v1, per-resource (memory, cpu, blkio) have it&rsquo;s own hierarchy, where each resource hierarchy contains cgroups for that resource."/>
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="https://zhiwayzhang.github.io/posts/cgroups/" /><link rel="prev" href="https://zhiwayzhang.github.io/posts/hadafs/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "Using Cgroups v2 to limit system I/O resources",
    "inLanguage": "en",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/zhiwayzhang.github.io\/posts\/cgroups\/"
    },"genre": "posts","keywords": "I\/O, Linux, Cgroups","wordcount":  1188 ,
    "url": "https:\/\/zhiwayzhang.github.io\/posts\/cgroups\/","datePublished": "2023-04-07T19:51:41+08:00","dateModified": "2023-04-07T19:51:41+08:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "Zhiwei Zhang"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="Coding Panda&#39;s Blog"><img loading="lazy" src="/img/kaifanle.gif" srcset="/img/kaifanle.gif, /img/kaifanle.gif 1.5x, /img/kaifanle.gif 2x" sizes="auto" data-title="Coding Panda&#39;s Blog" data-alt="Coding Panda&#39;s Blog" class="logo" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/><span class="header-title-text">Coding Panda&#39;s Blog</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/"
                
                
              ><i class="fa fa-home fa-fw fa-sm" aria-hidden="true"></i> Home</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> Archives</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title="Switch Theme">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="Coding Panda&#39;s Blog"><img loading="lazy" src="/img/kaifanle.gif" srcset="/img/kaifanle.gif, /img/kaifanle.gif 1.5x, /img/kaifanle.gif 2x" sizes="auto" data-title="/img/kaifanle.gif" data-alt="/img/kaifanle.gif" class="logo" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/><span class="header-title-text">Coding Panda&#39;s Blog</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/"
                  
                  
                ><i class="fa fa-home fa-fw fa-sm" aria-hidden="true"></i> Home</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> Archives</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><main class="container container-reverse"><aside class="toc" id="toc-auto"><h2 class="toc-title">Contents&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside>

  <aside class="aside-custom">
    </aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>Using Cgroups v2 to limit system I/O resources</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><a href="https://github.com/zhiwayzhang" title="Author"target="_blank" rel="external nofollow noopener noreferrer author" class="author"><img loading="lazy" src="/img/avatar.png" srcset="/img/avatar.png, /img/avatar.png 1.5x, /img/avatar.png 2x" sizes="auto" data-title="Zhiwei Zhang" data-alt="Zhiwei Zhang" class="avatar" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/>&nbsp;Zhiwei Zhang</a></span>
          <span class="post-category">included in <a href="/categories/tech/"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Tech</a></span></div>
      <div class="post-meta-line"><span title="published on 2023-04-07 19:51:41"><i class="fa-regular fa-calendar-alt fa-fw me-1" aria-hidden="true"></i><time datetime="2023-04-07">2023-04-07</time></span>&nbsp;<span title="Updated on 2023-04-07 19:51:41"><i class="fa-regular fa-edit fa-fw me-1" aria-hidden="true"></i><time datetime="2023-04-07">2023-04-07</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>1188 words</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>6 minutes</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>Contents</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#introduction-to-cgroups">Introduction to Cgroups</a></li>
    <li><a href="#the-hierarchy-of-cgroups">The hierarchy of Cgroups</a></li>
    <li><a href="#enable-cgroups-v2-in-linux">Enable cgroups v2 in Linux</a></li>
    <li><a href="#configure-cgroup-to-limit-io-resource">Configure cgroup to limit I/O resource</a></li>
    <li><a href="#summary">Summary</a></li>
    <li><a href="#reference">Reference</a></li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><h1 id="introduction-to-cgroups">Introduction to Cgroups</h1>
<p>Cgroups, which called control group in Linux to limit system resources for specify process group, is comonly used in many container tech, such as Docker, Kubernetes, iSulad etc.</p>
<p>The cgroup architecture is comprised of two main components:</p>
<ul>
<li>the cgroup core: which contains a pseudo-filesystem cgroupfs,</li>
<li>the subsystem controllers: thresholds for system resources, such as memory, CPU, I/O, PIDS, RDMA, etc.</li>
</ul>
<p><img loading="lazy" src="/img/HighLevelArch.png" srcset="/img/HighLevelArch.png, /img/HighLevelArch.png 1.5x, /img/HighLevelArch.png 2x" sizes="auto" data-title="high level hierarchy" data-alt="high level hierarchy" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<h1 id="the-hierarchy-of-cgroups">The hierarchy of Cgroups</h1>
<p>In Cgroups v1, per-resource (memory, cpu, blkio) have it&rsquo;s own hierarchy, where each resource hierarchy contains cgroups for that resource. The location of cgroup directory is <code>/sys/fs/cgroup/</code>.</p>
<div class="highlight" id="id-1"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ &gt; tree -L <span class="m">1</span> /sys/fs/cgroup
</span></span><span class="line"><span class="cl">/sys/fs/cgroup
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- blkio
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- cpu -&gt; cpu,cpuacct
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- cpuacct -&gt; cpu,cpuacct
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- cpu,cpuacct
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- cpuset
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- devices
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- freezer
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- hugetlb
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- memory
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- net_cls -&gt; net_cls,net_prio
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- net_cls,net_prio
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- net_prio -&gt; net_cls,net_prio
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- perf_event
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- pids
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- rdma
</span></span><span class="line"><span class="cl"><span class="sb">`</span>-- systemd</span></span></code></pre></td></tr></table>
</div>
</div><p>User can create sub cgroup in every resource diectory to limit the process usage of the resource.</p>
<p>Directory tree above shows the system resources can be control. #{TODO}</p>
<p>Unlike cgroup v1, v2 has only single hierarchy.</p>
<div class="highlight" id="id-2"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ &gt; ls -p /sys/fs/cgroup
</span></span><span class="line"><span class="cl">cgroup.controllers      cgroup.subtree_control  init.scope/      /sys/fs/cgroup/nvme/
</span></span><span class="line"><span class="cl">cgroup.max.depth        cgroup.threads          io.cost.model    system.slice/
</span></span><span class="line"><span class="cl">cgroup.max.descendants  cpu.pressure            io.cost.qos      user.slice/
</span></span><span class="line"><span class="cl">cgroup.procs            cpuset.cpus.effective   io.pressure
</span></span><span class="line"><span class="cl">cgroup.stat             cpuset.mems.effective   memory.pressure</span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>/sys/fs/cgroup</code> is the root cgroup. In Figure below shows the relationship between parent cgroup and child cgroup.</p>
<p><img loading="lazy" src="/img/hierarchyEXTERNAL.png" srcset="/img/hierarchyEXTERNAL.png, /img/hierarchyEXTERNAL.png 1.5x, /img/hierarchyEXTERNAL.png 2x" sizes="auto" data-title="hierarchy" data-alt="hierarchy" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<p>File <code>cgroup.controllers</code> lists the controllers available in this cgroup, the root cgroup has all the controllers on the system.</p>
<p>File <code>cgroup.subtree_control</code>  has the resource can be limited in it&rsquo;s child cgroup. Those limits can be inherited by sub cgroup.</p>
<p>The child cgroup&rsquo;s <code>cgroup.controllers</code> will generate by it&rsquo;s parent cgroup&rsquo;s <code>cgroup.subtree_control</code> file.</p>
<div class="highlight" id="id-3"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ &gt; cat cgroup.controllers
</span></span><span class="line"><span class="cl">cpuset cpu io memory pids rdma
</span></span><span class="line"><span class="cl">$ &gt; cat cgroup.subtree_control
</span></span><span class="line"><span class="cl">cpuset cpu io memory pids</span></span></code></pre></td></tr></table>
</div>
</div><p>This cgroup can limit cpuset, cpu, I/O, memory, rdma and pids, and it&rsquo;s child cgroup can limit cpuset, cpu, I/O, memory and pids.</p>
<p>To modify the <code>cgroup.subtree_control</code>, can use plus sign(+) or minus sign(-) to enable or disable controllers.</p>
<p>As in this example:</p>
<div class="highlight" id="id-4"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ &gt; <span class="nb">echo</span> <span class="s1">&#39;+cpu -memory&#39;</span> <span class="p">|</span> sudo tee /sys/fs/cgroup/cgroup.subtree_control</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="enable-cgroups-v2-in-linux">Enable cgroups v2 in Linux</h1>
<p>First, check the current cgroups fs version with command:</p>
<div class="highlight" id="id-5"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ &gt; stat -fc %T /sys/fs/cgroup/</span></span></code></pre></td></tr></table>
</div>
</div><p>For cgroup v2, the output is <code>cgroup2fs</code></p>
<p>For cgroup v1, the output is <code>tmpfs</code></p>
<p>If the output is <code>tmpfs</code>,</p>
<p>Edit grub config <code>/etc/default/grub</code>, append <code>systemd.unified_cgroup_hierarchy=1</code> to config <code>GRUB_CMDLINE_LINUX</code>.</p>
<div class="highlight" id="id-6"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">GRUB_CMDLINE_LINUX</span><span class="o">=</span><span class="s2">&#34;ip=dhcp console=ttyS0,115200 console=tty console=ttyS0 systemd.unified_cgroup_hierarchy=1&#34;</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Then execute <code>sudo update-grub</code>, after system reboot, the cgroups v2 will be enabled.</p>
<h1 id="configure-cgroup-to-limit-io-resource">Configure cgroup to limit I/O resource</h1>
<p>To create a new cgroup, use <code>mkdir</code> in <code>/sys/fs/cgroup/</code></p>
<div class="highlight" id="id-7"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ &gt; <span class="nb">cd</span> /sys/fs/cgroups/
</span></span><span class="line"><span class="cl">$ &gt; sudo mkdir nvme</span></span></code></pre></td></tr></table>
</div>
</div><p>In <code>nvme</code> directory, we have</p>
<div class="highlight" id="id-8"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ &gt; ls nvme/
</span></span><span class="line"><span class="cl">cgroup.controllers      cpu.max                cpuset.mems            memory.low
</span></span><span class="line"><span class="cl">cgroup.events           cpu.pressure           cpuset.mems.effective  memory.max
</span></span><span class="line"><span class="cl">cgroup.freeze           cpu.stat               io.max                 memory.min
</span></span><span class="line"><span class="cl">cgroup.max.depth        cpu.uclamp.max         io.pressure            memory.oom.group
</span></span><span class="line"><span class="cl">cgroup.max.descendants  cpu.uclamp.min         io.stat                memory.pressure
</span></span><span class="line"><span class="cl">cgroup.procs            cpu.weight             io.weight              memory.stat
</span></span><span class="line"><span class="cl">cgroup.stat             cpu.weight.nice        memory.current         pids.current
</span></span><span class="line"><span class="cl">cgroup.subtree_control  cpuset.cpus            memory.events          pids.events
</span></span><span class="line"><span class="cl">cgroup.threads          cpuset.cpus.effective  memory.events.local    pids.max
</span></span><span class="line"><span class="cl">cgroup.type             cpuset.cpus.partition  memory.high</span></span></code></pre></td></tr></table>
</div>
</div><p>To enable the control to <code>I/O</code> resources, we need to enable the I/O controller in the <code>/sys/fs/cgroup.subtree_control</code> of root cgroup.</p>
<div class="highlight" id="id-9"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ /sys/fs/cgroup&gt; <span class="nb">echo</span> <span class="s2">&#34;+io&#34;</span> <span class="p">|</span> sudo tee cgroup.subtree_control
</span></span><span class="line"><span class="cl">$ /sys/fs/cgroup&gt; sudo <span class="nb">echo</span> <span class="s2">&#34;+io&#34;</span> &gt; cgroup.subtree_control <span class="c1"># permission denied</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Dont&rsquo;t use <code>&gt;</code> to redirect output to this file (<strong>unles in sudo mode</strong>), because <code>&gt;</code>  shell process redirection first before running follwing command, so the <code>sudo</code>  command did not take effect.</p>
<p>We also need to find out the major and minor number of block devices.</p>
<div class="highlight" id="id-10"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ &gt; cat /proc/partitions
</span></span><span class="line"><span class="cl">major minor  <span class="c1">#blocks  name</span>
</span></span><span class="line"><span class="cl">	...			...		....		...
</span></span><span class="line"><span class="cl">   <span class="m">8</span>        <span class="m">0</span>   <span class="m">83886080</span> sda
</span></span><span class="line"><span class="cl">   <span class="m">8</span>        <span class="m">1</span>       <span class="m">1024</span> sda1
</span></span><span class="line"><span class="cl">   <span class="m">8</span>        <span class="m">2</span>   <span class="m">83883008</span> sda2
</span></span><span class="line"><span class="cl">   <span class="m">2</span>        <span class="m">0</span>          <span class="m">4</span> fd0
</span></span><span class="line"><span class="cl"> <span class="m">259</span>        <span class="m">0</span>    <span class="m">4194304</span> nvme0n1</span></span></code></pre></td></tr></table>
</div>
</div><p>We will use the <code>major</code> and <code>minor </code>number of <code>nvme0n1</code> device partition.</p>
<p>There also have other control keys:</p>
<ul>
<li><code>riops</code>: Max read I/O operations per second</li>
<li><code>wiops</code>: Max write I/O operations per second</li>
<li><code>rbps</code>: Max read bytes per second</li>
<li><code>wbps</code>: Max write bytes per second</li>
</ul>
<p>The lines of <code>io.max</code> must keyed by <code>$MAJOR:$MINOR riops=? wiops=? rbps=? wbps=?</code></p>
<p>We can remove the limit of control by setting <code>riops=max</code> etc.</p>
<p>We limit the write bandwidth (wbps, write bytes per second) of <code>io.max</code> to  1 MB/s:</p>
<div class="highlight" id="id-11"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ &gt; /sys/fs/cgroup/nvme&gt; <span class="nb">echo</span> <span class="s2">&#34;259:0 wbps=1048576&#34;</span> <span class="p">|</span> sudo tee io.max</span></span></code></pre></td></tr></table>
</div>
</div><p>After configured the I/O limit of resources, now we need to add the process pid will be controled.</p>
<p>When execute this command,  <code>$$</code> means the pid of current shell :</p>
<div class="highlight" id="id-12"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ &gt; /sys/fs/cgroup/nvme&gt; <span class="nb">echo</span> <span class="nv">$$</span> <span class="p">|</span> sudo tee cgroup.procs</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, let&rsquo;s use <code>dd</code> to generate I/O workload, before we start testing, clear the page cache first!</p>
<p>Clear the page cache:</p>
<div class="highlight" id="id-13"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$&gt; free -h
</span></span><span class="line"><span class="cl">              total        used        free      shared  buff/cache   available
</span></span><span class="line"><span class="cl">Mem:          3.8Gi       169Mi       3.6Gi       0.0Ki       107Mi       3.5Gi
</span></span><span class="line"><span class="cl">Swap:         3.8Gi          0B       3.8Gi
</span></span><span class="line"><span class="cl">$&gt; sync <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="m">1</span> <span class="p">|</span> sudo tee /proc/sys/vm/drop_caches
</span></span><span class="line"><span class="cl">$&gt; free -h
</span></span><span class="line"><span class="cl">              total        used        free      shared  buff/cache   available
</span></span><span class="line"><span class="cl">Mem:          3.8Gi       168Mi       3.6Gi       0.0Ki       105Mi       3.5Gi
</span></span><span class="line"><span class="cl">Swap:         3.8Gi          0B       3.8Gi</span></span></code></pre></td></tr></table>
</div>
</div><p>Use <code>dd</code> to generate I/O workload:</p>
<div class="highlight" id="id-14"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ &gt; sudo dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>/tmp/test/file1 <span class="nv">bs</span><span class="o">=</span>1M <span class="nv">count</span><span class="o">=</span><span class="m">100</span>
</span></span><span class="line"><span class="cl">100+0 records in
</span></span><span class="line"><span class="cl">100+0 records out
</span></span><span class="line"><span class="cl"><span class="m">104857600</span> bytes <span class="o">(</span><span class="m">105</span> MB, <span class="m">100</span> MiB<span class="o">)</span> copied, 0.0560001 s, 1.9 GB/s</span></span></code></pre></td></tr></table>
</div>
</div><p>Note that, the data had been writen to page cache immediately.</p>
<p>Using <code>iostat</code> to monitor the writeback performance, we can found that the <code>MB_wrtn/s</code> is  limited to <code>1.0MB/s</code>, which is a difference between cgroups v1 and v2 that cgroups v2 can limit the writeback bandwidth.</p>
<div class="highlight" id="id-15"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ &gt; iostat -h -m -d <span class="m">1</span> <span class="m">100</span>
</span></span><span class="line"><span class="cl">Linux 5.4.0-64-generic <span class="o">(</span>fvm<span class="o">)</span> 	04/08/2023 	_x86_64_	<span class="o">(</span><span class="m">4</span> CPU<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">avg-cpu:  %user   %nice %system %iowait  %steal   %idle
</span></span><span class="line"><span class="cl">           0.8%    0.4%    1.5%   23.1%    0.0%   74.2%
</span></span><span class="line"><span class="cl">										......................................
</span></span><span class="line"><span class="cl">      tps    MB_read/s    MB_wrtn/s    MB_dscd/s    MB_read    MB_wrtn    MB_dscd Device
</span></span><span class="line"><span class="cl">     0.00         0.0k         0.0k         0.0k       0.0k       0.0k       0.0k fd0
</span></span><span class="line"><span class="cl">     0.00         0.0k         0.0k         0.0k       0.0k       0.0k       0.0k loop0
</span></span><span class="line"><span class="cl">     0.00         0.0k         0.0k         0.0k       0.0k       0.0k       0.0k loop1
</span></span><span class="line"><span class="cl">     0.00         0.0k         0.0k         0.0k       0.0k       0.0k       0.0k loop2
</span></span><span class="line"><span class="cl">     0.00         0.0k         0.0k         0.0k       0.0k       0.0k       0.0k loop3
</span></span><span class="line"><span class="cl">     0.00         0.0k         0.0k         0.0k       0.0k       0.0k       0.0k loop4
</span></span><span class="line"><span class="cl">     0.00         0.0k         0.0k         0.0k       0.0k       0.0k       0.0k loop5
</span></span><span class="line"><span class="cl">     0.00         0.0k         0.0k         0.0k       0.0k       0.0k       0.0k loop6
</span></span><span class="line"><span class="cl">     0.00         0.0k         0.0k         0.0k       0.0k       0.0k       0.0k loop7
</span></span><span class="line"><span class="cl">     0.00         0.0k         0.0k         0.0k       0.0k       0.0k       0.0k loop8
</span></span><span class="line"><span class="cl">     3.00         0.0k         1.0M         0.0k       0.0k       1.0M       0.0k nvme0n1
</span></span><span class="line"><span class="cl">     0.00         0.0k         0.0k         0.0k       0.0k       0.0k       0.0k sda</span></span></code></pre></td></tr></table>
</div>
</div><p>Furthermore, when add the <code>direct</code> oflag which means directly write data to device without page cache, the write bandwidth is limited to <code>1.0 MB/s</code>.</p>
<div class="highlight" id="id-16"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ &gt; sudo dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>/tmp/test/file1 <span class="nv">bs</span><span class="o">=</span>1M <span class="nv">count</span><span class="o">=</span><span class="m">100</span> <span class="nv">oflag</span><span class="o">=</span>d
</span></span><span class="line"><span class="cl">irect
</span></span><span class="line"><span class="cl">100+0 records in
</span></span><span class="line"><span class="cl">100+0 records out
</span></span><span class="line"><span class="cl"><span class="m">104857600</span> bytes <span class="o">(</span><span class="m">105</span> MB, <span class="m">100</span> MiB<span class="o">)</span> copied, 100.003 s, 1.0 MB/s</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="summary">Summary</h1>
<p>In this article, we can learn about Cgroups in Linux, and how to use Cgroups to limit system I/O resources.</p>
<p>In a subsequent article, I will introduce some system API related to Cgroups.</p>
<h1 id="reference">Reference</h1>
<ol>
<li><a href="https://facebookmicrosites.github.io/cgroup2/docs/overview.html"target="_blank" rel="external nofollow noopener noreferrer">https://facebookmicrosites.github.io/cgroup2/docs/overview.html</a></li>
<li><a href="https://kubernetes.io/docs/concepts/architecture/cgroups/"target="_blank" rel="external nofollow noopener noreferrer">https://kubernetes.io/docs/concepts/architecture/cgroups/</a></li>
<li><a href="https://andrestc.com/post/cgroups-io/"target="_blank" rel="external nofollow noopener noreferrer">https://andrestc.com/post/cgroups-io/</a></li>
<li><a href="https://docs.kernel.org/admin-guide/cgroup-v2.html"target="_blank" rel="external nofollow noopener noreferrer">https://docs.kernel.org/admin-guide/cgroup-v2.html</a></li>
<li><a href="https://manpath.be/f35/7/cgroups#L557"target="_blank" rel="external nofollow noopener noreferrer">https://manpath.be/f35/7/cgroups#L557</a></li>
<li><a href="https://zorrozou.github.io/docs/%E8%AF%A6%E8%A7%A3Cgroup%20V2.html"target="_blank" rel="external nofollow noopener noreferrer">https://zorrozou.github.io/docs/%E8%AF%A6%E8%A7%A3Cgroup%20V2.html</a></li>
</ol>
</div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="Updated on 2023-04-07 19:51:41">Updated on 2023-04-07&nbsp;</span>
      </div><div class="post-info-license">
          <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span>
        </div></div>
    <div class="post-info-line">
      <div class="post-info-md"></div>
      <div class="post-info-share">
        <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://zhiwayzhang.github.io/posts/cgroups/" data-title="Using Cgroups v2 to limit system I/O resources" data-hashtags="I/O,Linux,Cgroups"><i class="fa-brands fa-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://zhiwayzhang.github.io/posts/cgroups/" data-hashtag="I/O"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="https://zhiwayzhang.github.io/posts/cgroups/" data-title="Using Cgroups v2 to limit system I/O resources"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  </span>
      </div>
    </div>
  </div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href='/tags/i/o/' class="post-tag">I/O</a><a href='/tags/linux/' class="post-tag">Linux</a><a href='/tags/cgroups/' class="post-tag">Cgroups</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/posts/hadafs/" class="post-nav-item" rel="prev" title="[FAST&#39;23] HadaFS: A File System Bridging the Local and Shared Burst Buffer for Exascale Supercomputers"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>[FAST&#39;23] HadaFS: A File System Bridging the Local and Shared Burst Buffer for Exascale Supercomputers</a></div>
</div>
</article></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.119.0">Hugo</a> | Theme - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt %!v(MISSING)">FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2019 - 2023</span><span class="author" itemprop="copyrightHolder">
              <a href="https://github.com/zhiwayzhang"target="_blank" rel="external nofollow noopener noreferrer">Zhiwei Zhang</a></span></div><div class="footer-line statistics"></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="Back to Top"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">Theme FixIt works best with JavaScript enabled.</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.8.0/build/styles/github-dark.min.css"><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.8.0/build/highlight.min.js" defer></script><script>window.config={"code":{"copyTitle":"Copy to clipboard","editLockTitle":"Lock editable code block","editUnLockTitle":"Unlock editable code block","editable":true,"maxShownLines":10},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script src="/js/theme.min.js" defer></script></body>
</html>
